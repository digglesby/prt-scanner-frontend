<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" type="text/css" href="styles.css">
    <link rel="functions" href="compute.js">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <link rel="prtdata" href="https://watjl80v2k.execute-api.us-east-1.amazonaws.com/Test1">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.2"></script>

    <title>P.R.T. Scanner</title>
  </head>
<!-- onLoad="prtStatusFunction();" -->
  <body  style="background-color: white";>
    <h1>PRT Scanner</h1>
    <div class="topnav" id="myTopnav">
      <a href="#home" class="active">Home</a>
      <a href="#news">Stochastics (N/A)</a>
      <a href="#contact">Contact (N/A)</a>
      <a href="#about">About (N/A)</a>
      <a href="javascript:void(0);" style="font-size:15px;" class="icon" onclick="myFunction()">&#9776;</a>
    </div>

    <div class="PrtStatusBody" id="PrtStatusBody">
      <h2>Current PRT Status</h2>
      <p>
        <span class="StationStatus" id="StationStatus">Beechurst Station: </span>
          <span class="PRTLoading_B" id="PRTLoading_B">Loading...</span> <img id="PRTIcon_B" src=""/>
        <br style="display=none"></br>

        <span class="StationStatus" id="StationStatus">Evansdale Station: </span>
          <span class="PRTLoading_Evan" id="PRTLoading_Evan">Loading...</span> <img id="PRTIcon_Evan" src=""/>
        <br style="display=none"></br>

        <span class="StationStatus" id="StationStatus">Enginnering Station: </span>
          <span class="PRTLoading_Eng" id="PRTLoading_Eng">Loading...</span> <img id="PRTIcon_Eng" src=""/>
        <br style="display=none"></br>

        <span class="StationStatus" id="StationStatus">HSC Station: </span>
          <span class="PRTLoading_H" id="PRTLoading_H">Loading...</span> <img id="PRTIcon_H" src=""/>
        <br style="display=none"></br>

        <span class="StationStatus" id="StationStatus">Walnut Station: </span>
          <span class="PRTLoading_W" id="PRTLoading_W">Loading...</span> <img id="PRTIcon_W" src=""/>
      </p>
      <h2>Graphs</h2>
      <canvas id="histogram"></canvas>
      <p>Time Periods the PRT Shuttle goes Down</p>
      <p></p>
    </div>

    <script>
    $.ajax(
    {
      type: "GET",
      url: "https://watjl80v2k.execute-api.us-east-1.amazonaws.com/Test1",
      data: "",
      crossDomain: true,
      dataType: 'json',
      success: function(data, status)
      {

        console.log("Status: "+ status + " connecting to apigateway." + "\nData:");
        prtStatusFunction(data);
        histogramData(data);

      },

      error: function(response)
      {
        console.log(response);
      },

    });

    var ctx = document.getElementById('histogram').getContext('2d');
    var chart = new Chart(ctx, {
    // The type of chart we want to create
    type: 'bar',

    // The data for our dataset
    data: {
        datasets: [{
            label: 'Downs',
            data: [],
            backgroundColor: 'rgb(36,36,64)',
            borderColor: 'rgb(133, 150, 167)',
            // this dataset is drawn below
            order: 2
        }, {
            label: 'Downs',
            data: [],
            type: 'line',
            borderColor: 'rgb(255, 171, 0)',
            // this dataset is drawn on top
            order: 1
        }],
        labels: ['6AM', '7AM', '8AM', '9AM', '10AM', '11AM', '12PM', '1PM', '2PM', '3PM', '4PM', '5PM', '6PM', '7PM', '8PM', '9PM', '10PM']
    },

    // Configuration options go here
    options:
    {
      legend: {display: false}
    }
    });

    function sortDate(data, array)
    {
      for (var a = 0; a < data[array].length; a++)
      {
        for (var b = 0; b < data[array].length -a -1; b++)
         {
           // slice the date and split it between 3 integers hour, minute, second between group A and B.
          var hourA = data[array][b].Date.slice(11,13);
          var minuteA = data[array][b].Date.slice(14,16);
          var secondA = data[array][b].Date.slice(17);

          var hourB = data[array][b+1].Date.slice(11,13);
          var minuteB = data[array][b+1].Date.slice(14,16);
          var secondB = data[array][b+1].Date.slice(17);

          // Hours
          if (hourA > hourB)
          {
            var temp = data[array][b];
            data[array][b] = data[array][b+1];
            data[array][b+1] = temp;
          }
          // Minutes
          else if (hourA == hourB && minuteA > minuteB)
          {
            var temp = data[array][b];
            data[array][b] = data[array][b+1];
            data[array][b+1] = temp;
          }
          //Seconds
          else if (hourA == hourB && minuteA == minuteB && secondA > secondB )
          {
            var temp = data[array][b];
            data[array][b] = data[array][b+1];
            data[array][b+1] = temp;
          }
        }
      }
    }

    function myFunction()
    {
      var x = document.getElementById("myTopnav");
      if (x.className === "topnav") {
        x.className += " responsive";
      } else
      {
        x.className = "topnav";
      }
    }

    function parseHour(Date)
    {
      var hour = + parseInt((Date.slice(11,13)));
      //we do this because we are setting the correct index from count array.
      if (+hour >= 6 && +hour <= 22)
      {
        switch (+hour)
        {
          case 6:
            hour = 0;
            break;
          case 7:
            hour = 1;
            break;
          case 8:
            hour = 2;
            break;
          case 9:
            hour = 3;
            break;
          case 10:
            hour = 4;
            break;
          case 11:
            hour = 5;
            break;
          case 12:
            hour = 6;
            break;
          case 13:
            hour = 7;
            break;
          case 14:
            hour = 8;
            break;
          case 15:
            hour = 9;
            break;
          case 16:
            hour = 10;
            break;
          case 17:
            hour = 11;
            break;
          case 18:
            hour = 12;
            break;
          case 19:
            hour = 13;
            break;
          case 20:
            hour = 14;
            break;
          case 21:
            hour = 15;
            break;
          case 22:
            hour = 16;
            break;
        }
      }
      return +hour;
    }

    function histogramData(data)
    {
      var time  = [6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22];
      var count = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];

      for (var a = 0; a < data.length; a++)
      {
        if (a % 2 != 0 && data[a].length != 0)
        {
          for (var b = 0; b < data[a].length; b++)
          {
            var currentHour = parseHour(data[a][b].Date);
            if (data[a][b].IsDown.search("Beechurst") != -1)
            {
              count[currentHour]++;
            }

            if (data[a][b].IsDown.search("Towers") != -1)
            {
              count[currentHour]++;
            }

            if (data[a][b].IsDown.search("Engineering") != -1)
            {
              count[currentHour]++;
            }

            if (data[a][b].IsDown.search("HSC") != -1)
            {
              count[currentHour]++;
            }

            if (data[a][b].IsDown.search("Walnut") != -1)
            {
              count[currentHour]++;
            }
          }
        }
      }

      for (var i = 0; i < time.length; i++)
      {
        console.log("Time: " + time[i]  + " count: " + count[i]);
      }

      updateData(count);
    }

    function updateData(arrayUpdate)
    {
  		chart.data.datasets[0].data = arrayUpdate;
      chart.data.datasets[1].data = arrayUpdate;
      chart.update();
    }

    function prtStatusFunction(data)
    {
      var firstObject = 1;
      var listOfStations = ["PRTLoading_B", "PRTLoading_Evan", "PRTLoading_Eng", "PRTLoading_H", "PRTLoading_W"];
      var listStationIcons = ["PRTIcon_B", "PRTIcon_Evan", "PRTIcon_Eng", "PRTIcon_H", "PRTIcon_W"];
      var length = data[firstObject].length-1;
      if (data[firstObject].length != 0)
      {

        console.log("Before Sort:" + data[firstObject][length].Date + " " + data[firstObject][length].IsDown);
        sortDate(data,firstObject);
        console.log("After Sort:" + data[firstObject][length].Date + " " + data[firstObject][length].IsDown);
        var currentStatus = data[firstObject][length].IsDown;
          //PRTLoading_B
          if (currentStatus.search("Beechurst") == -1)
          {
            document.getElementById(listOfStations[0]).innerHTML = "Running";
            document.getElementById(listOfStations[0]).className = 'PRTRunning';
            document.getElementById(listStationIcons[0]).src = "prtRunning.ico";
          }
          else
          {
            document.getElementById(listOfStations[0]).innerHTML = "Down";
            document.getElementById(listOfStations[0]).className = 'PRTDown';
            document.getElementById(listStationIcons[0]).src = "prtDown.ico";
          }

          //PRTLoading_Evan
          if (currentStatus.search("Towers") == -1)
          {
            document.getElementById(listOfStations[1]).innerHTML = "Running";
            document.getElementById(listOfStations[1]).className = 'PRTRunning';
            document.getElementById(listStationIcons[1]).src = "prtRunning.ico";
          }
          else
          {
            document.getElementById(listOfStations[1]).innerHTML = "Down";
            document.getElementById(listOfStations[1]).className = 'PRTDown';
            document.getElementById(listStationIcons[1]).src = "prtDown.ico";

          }

          //PRTLoading_Eng
          if (currentStatus.search("Engineering") == -1)
          {
            document.getElementById(listOfStations[2]).innerHTML = "Running";
            document.getElementById(listOfStations[2]).className = 'PRTRunning';
            document.getElementById(listStationIcons[2]).src = "prtRunning.ico";
          }
          else
          {
            document.getElementById(listOfStations[2]).innerHTML = "Down";
            document.getElementById(listOfStations[2]).className = 'PRTDown';
            document.getElementById(listStationIcons[2]).src = "prtDown.ico";
          }

          //PRTLoading_H
          if (currentStatus.search("HSC") == -1)
          {
            document.getElementById(listOfStations[3]).innerHTML = "Running";
            document.getElementById(listOfStations[3]).className = 'PRTRunning';
            document.getElementById(listStationIcons[3]).src = "prtRunning.ico";
          }
          else
          {
            document.getElementById(listOfStations[3]).innerHTML = "Down";
            document.getElementById(listOfStations[3]).className = 'PRTDown';
            document.getElementById(listStationIcons[3]).src = "prtDown.ico";
          }

          //PRTLoading_W
          if (currentStatus.search("Walnut") == -1)
          {
            document.getElementById(listOfStations[4]).innerHTML = "Running";
            document.getElementById(listOfStations[4]).className = 'PRTRunning';
            document.getElementById(listStationIcons[4]).src = "prtRunning.ico";
          }
          else
          {
            document.getElementById(listOfStations[4]).innerHTML = "Down";
            document.getElementById(listOfStations[4]).className = 'PRTDown';
            document.getElementById(listStationIcons[4]).src = "prtDown.ico";
          }

          if (currentStatus.search("closed") != -1)
          {
            document.getElementById(listOfStations[0]).innerHTML = "Closed";
            document.getElementById(listOfStations[0]).className = 'PRTDown';

            document.getElementById(listOfStations[1]).innerHTML = "Closed";
            document.getElementById(listOfStations[1]).className = 'PRTDown';

            document.getElementById(listOfStations[2]).innerHTML = "Closed";
            document.getElementById(listOfStations[2]).className = 'PRTDown';

            document.getElementById(listOfStations[3]).innerHTML = "Closed";
            document.getElementById(listOfStations[3]).className = 'PRTDown';

            document.getElementById(listOfStations[4]).innerHTML = "Closed";
            document.getElementById(listOfStations[4]).className = 'PRTDown';
          }
      }
      else
      {
        document.getElementById(listOfStations[0]).innerHTML = "Closed";
        document.getElementById(listOfStations[0]).className = 'PRTDown';

        document.getElementById(listOfStations[1]).innerHTML = "Closed";
        document.getElementById(listOfStations[1]).className = 'PRTDown';

        document.getElementById(listOfStations[2]).innerHTML = "Closed";
        document.getElementById(listOfStations[2]).className = 'PRTDown';

        document.getElementById(listOfStations[3]).innerHTML = "Closed";
        document.getElementById(listOfStations[3]).className = 'PRTDown';

        document.getElementById(listOfStations[4]).innerHTML = "Closed";
        document.getElementById(listOfStations[4]).className = 'PRTDown';
      }
    }
    </script>
  </body>

</html>
